<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stillness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 12px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-weight: 700;
        }

        .header p {
            font-size: 1.15em;
            opacity: 1;
        }

        .header .app-summary {
            margin-top: 20px;
            font-size: 1.05em;
            opacity: 0.95;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn-recap {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 14px;
        }

        .btn-recap:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-recap:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .recap-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #dee2e6;
        }

        .recap-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress bar styles for SSE streaming */
        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .progress-bar-wrapper {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease-out;
            width: 0%;
        }

        .progress-message {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .progress-details {
            font-size: 0.9em;
            color: #666;
        }

        .progress-percentage {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            text-align: right;
        }

        .progress-call-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .progress-call-info .call-number {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .progress-call-info .call-title {
            flex: 1;
            font-weight: 500;
        }

        .progress-call-info .call-date {
            color: #666;
            font-size: 0.9em;
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .insight {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .insight.critical {
            border-left-color: #e74c3c;
        }

        .insight.important {
            border-left-color: #f39c12;
        }

        .insight.minor {
            border-left-color: #3498db;
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .insight-category {
            font-weight: 600;
            color: #333;
        }

        .insight-timestamp {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .insight-section {
            margin: 10px 0;
        }

        .insight-section strong {
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        .example-phrasing {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            color: #2c3e50;
            border: 1px solid #e0e0e0;
            margin-top: 10px;
        }

        .conversation-snippet {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #667eea;
        }

        .conversation-snippet strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
        }

        .conversation-snippet pre {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #2c3e50;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .list {
            list-style: none;
            padding: 0;
        }

        .list li {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .list li:last-child {
            border-bottom: none;
        }

        .list li:before {
            content: "âœ“ ";
            color: #27ae60;
            font-weight: bold;
            margin-right: 8px;
        }

        .improvement-list li:before {
            content: "â†’ ";
            color: #e74c3c;
        }

        /* Call Classification Styles */
        .classification-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: white;
        }

        .classification-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .call-type-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .call-type-badge.discovery {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .call-type-badge.poc_scoping {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .call-type-badge.mixed {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
        }

        .call-type-badge.unclear {
            background: #666;
        }

        .confidence-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            background: rgba(255,255,255,0.2);
        }

        .classification-reasoning {
            font-style: italic;
            opacity: 0.9;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .criteria-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .criteria-card h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .progress-fill.low { background: #e74c3c; }
        .progress-fill.medium { background: #f39c12; }
        .progress-fill.high { background: #27ae60; }

        .criteria-checklist {
            list-style: none;
            padding: 0;
            font-size: 0.9em;
        }

        .criteria-checklist li {
            padding: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .criteria-checklist li:last-child {
            border-bottom: none;
        }

        .check-icon { color: #27ae60; }
        .x-icon { color: #e74c3c; opacity: 0.7; }

        .missing-elements {
            background: rgba(231, 76, 60, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .missing-elements h4 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .missing-elements ul {
            list-style: none;
            padding: 0;
        }

        .missing-elements li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .missing-elements li:before {
            content: "âš ";
            position: absolute;
            left: 0;
        }

        .recommendations-section {
            background: rgba(39, 174, 96, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .recommendations-section h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .recommendations-section ul {
            list-style: none;
            padding: 0;
        }

        .recommendations-section li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .recommendations-section li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #27ae60;
        }

        /* Evidence and Missed Opportunity Styles */
        .evidence-item {
            background: rgba(39, 174, 96, 0.15);
            border-left: 3px solid #27ae60;
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.9em;
        }

        .evidence-item .timestamp-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .evidence-item .snippet {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            margin-top: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
        }

        .missed-opportunity-item {
            background: rgba(231, 76, 60, 0.15);
            border-left: 3px solid #e74c3c;
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.9em;
        }

        .missed-opportunity-item .timestamp-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .missed-opportunity-item .suggested-question {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            margin-top: 8px;
            border-radius: 4px;
            font-style: italic;
            border-left: 2px solid #f39c12;
        }

        .missed-opportunity-item .why-important {
            margin-top: 6px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .criteria-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .criteria-section-header:hover {
            background: rgba(255,255,255,0.1);
        }

        .evidence-count {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .opportunity-count {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .help-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .tabs-container {
            display: flex;
            gap: 0;
            min-height: 500px;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 220px;
            min-width: 220px;
            padding-right: 20px;
            border-right: 2px solid #e0e0e0;
            margin-right: 20px;
        }

        .tab {
            padding: 15px 20px;
            background: none;
            border: none;
            border-left: 3px solid transparent;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            border-radius: 0 8px 8px 0;
        }

        .tab:hover {
            color: #667eea;
            background: #f5f5f5;
        }

        .tab.active {
            color: #667eea;
            border-left-color: #667eea;
            background: #f0f4ff;
        }

        .tab-content-wrapper {
            flex: 1;
            min-width: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§˜ Stillness</h1>
            <p class="app-summary">
                <strong>360Â° prospect intelligence:</strong> CRM data, call insights, product usage, and user behaviorâ€”unified in one place to prepare for your next customer conversation.
            </p>
        </div>

        <div class="card">
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab" onclick="switchTab('hypothesis', event)">ðŸ”¬ Hypothesis Research</button>
                    <button class="tab active" onclick="switchTab('prospect', event)">ðŸ“Š Prospect Overview</button>
                    <button class="tab" onclick="switchTab('demo', event)">ðŸŽ¯ Custom Demo Builder</button>
                    <button class="tab" onclick="switchTab('gong', event)">ðŸ”— Gong URL</button>
                </div>

                <div class="tab-content-wrapper">
            <div id="gong-tab" class="tab-content">
                <div class="input-section">
                    <label for="gongUrl">Gong Call URL</label>
                    <input
                        type="text"
                        id="gongUrl"
                        placeholder="https://app.gong.io/call?id=YOUR_CALL_ID"
                    >
                    <p class="help-text">
                        ðŸš€ Paste a Gong call URL and we'll automatically fetch and analyze the transcript.
                    </p>
                </div>
            </div>

            <div id="prospect-tab" class="tab-content active">
                <div class="input-section">
                    <label for="accountName">Account Name</label>
                    <input
                        type="text"
                        id="accountName"
                        placeholder="e.g., Acme Corp, OpenAI, Stripe"
                    >
                    <p class="help-text">
                        Search by account/company name (fuzzy matching supported).
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="accountDomain">Email Domain (Optional)</label>
                    <input
                        type="text"
                        id="accountDomain"
                        placeholder="e.g., acme.com, openai.com"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Search by email domain from website.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="sfdcAccountId">Salesforce Account ID (Optional)</label>
                    <input
                        type="text"
                        id="sfdcAccountId"
                        placeholder="e.g., 001..."
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Exact match on Salesforce Account ID (most precise).
                    </p>
                </div>
                <p class="help-text" style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px;">
                    ðŸ“Š <strong>Prospect Overview</strong> pulls data from BigQuery including Salesforce account details, 
                    opportunities, Gong call analytics, Pendo product usage, and FullStory user data.
                </p>
            </div>

            <div id="demo-tab" class="tab-content">
                <div class="input-section">
                    <label for="demoAccountName">Prospect / Account Name</label>
                    <input
                        type="text"
                        id="demoAccountName"
                        placeholder="e.g., Acme Corp, Stripe, Datadog"
                    >
                    <p class="help-text">
                        Enter a prospect name. We'll pull their profile from BigQuery and generate a tailored demo with real traces sent to Arize.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="demoModelSelect">LLM Model for Demo Traces</label>
                    <select id="demoModelSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                        <option value="gpt-5.2" selected>GPT-5.2</option>
                        <option value="claude-opus-4-6">Claude Opus 4.6</option>
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                        <option value="gpt-4.1">GPT-4.1</option>
                        <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                    </select>
                    <p class="help-text">
                        The LLM model used inside the generated demo traces. Appears in Arize as the model powering the pipeline.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="demoProjectName">Arize Project Name (optional)</label>
                    <input
                        type="text"
                        id="demoProjectName"
                        placeholder="e.g., acme-demo"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Name of the Arize project where traces will land. Defaults to the prospect name.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="demoArizeSpaceId">Arize Space ID (optional)</label>
                    <input
                        type="text"
                        id="demoArizeSpaceId"
                        placeholder="Leave blank to use app default"
                        autocomplete="off"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Your Arize Space ID. If set, traces from this demo are sent to this space instead of the app default.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="demoArizeApiKey">Arize API Key (optional)</label>
                    <input
                        type="password"
                        id="demoArizeApiKey"
                        placeholder="Leave blank to use app default"
                        autocomplete="off"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Your Arize API key. Use with Space ID above to send traces to your own Arize project.
                    </p>
                </div>
                <p class="help-text" style="margin-top: 15px; padding: 12px; background: #fff3e0; border-radius: 8px;">
                    ðŸŽ¯ <strong>Custom Demo Builder</strong> fetches the prospect's full profile from BigQuery,
                    analyzes Gong call data and key discussion points to identify what they're building,
                    then runs a matching AI application (RAG, text-to-SQL, chatbot, or agent) instrumented with OpenTelemetry.
                    Traces are sent to Arize automatically so you can walk through a tailored demo.
                </p>
            </div>

            <div id="hypothesis-tab" class="tab-content">
                <div class="input-section">
                    <label for="hypCompanyName">Company Name</label>
                    <input
                        type="text"
                        id="hypCompanyName"
                        placeholder="e.g., Stripe, Datadog, Snowflake"
                    >
                    <p class="help-text">
                        Enter a company name to research their AI/ML signals and generate data-driven hypotheses.
                    </p>
                </div>
                <div class="input-section" style="margin-top: 15px;">
                    <label for="hypDomain">Domain (Optional)</label>
                    <input
                        type="text"
                        id="hypDomain"
                        placeholder="e.g., stripe.com"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    >
                    <p class="help-text">
                        Company domain for more precise web research.
                    </p>
                </div>
                <p class="help-text" style="margin-top: 15px; padding: 12px; background: #ede7f6; border-radius: 8px;">
                    ðŸ”¬ <strong>Hypothesis Research</strong> uses an AI agent to research companies via web search and CRM data,
                    then generates ranked hypotheses with discovery questions, competitive context, and similar customer proof points.
                </p>
            </div>

            <div class="input-section" style="margin-bottom: 20px;">
                <label for="modelSelect">AI Model</label>
                <select id="modelSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                    <option value="gpt-4o-mini" selected>GPT-4o Mini (Fast, ~30-60s)</option>
                    <option value="gpt-5.2">GPT-5.2 (Latest, slower)</option>
                    <option value="gpt-4o">GPT-4o (Most Capable)</option>
                    <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Fast, Cost-effective)</option>
                    <option value="claude-sonnet-4">Claude 4 Sonnet (Balanced)</option>
                </select>
                <p class="help-text">
                    Choose the AI model for analysis. Haiku is fastest, Sonnet/GPT-4o provide deeper insights.
                </p>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="handleAnalyze()" id="analyzeBtn">
                    Analyze
                </button>
            </div>
                </div>
            </div>
        </div>

        <div id="loading" class="card loading" style="display: none;">
            <div class="spinner"></div>
            <p id="loading-message">Analyzing call transcript with AI...</p>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">This may take 30-60 seconds</p>
        </div>

        <!-- Demo use-case confirmation -->
        <div id="demo-confirm" class="card" style="display: none;">
            <h3 style="margin-bottom: 5px;">Confirm Use Case</h3>
            <p id="confirm-reasoning" style="color: #666; font-size: 0.9em; margin-bottom: 8px;"></p>
            <p id="confirm-data-sources" style="color: #888; font-size: 0.8em; margin-bottom: 15px; font-style: italic;"></p>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label for="confirmUseCase" style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em;">Use Case</label>
                    <select id="confirmUseCase" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;"></select>
                </div>
                <div style="flex: 1;">
                    <label for="confirmFramework" style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em;">Framework</label>
                    <select id="confirmFramework" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;"></select>
                </div>
            </div>
            <p id="confirm-industry" style="color: #888; font-size: 0.85em; margin-top: 10px;"></p>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmAndGenerate()">Confirm & Generate</button>
                <button onclick="cancelDemo()" style="padding: 10px 20px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; font-size: 14px;">Cancel</button>
            </div>
        </div>

        <!-- Progress container for SSE streaming (prospect timeline) -->
        <div id="progress-loading" class="card" style="display: none;">
            <div class="progress-container">
                <div class="progress-message" id="progress-message">Starting analysis...</div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="progress-details" id="progress-details"></div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>
                <div class="progress-call-info" id="progress-call-info" style="display: none;">
                    <span class="call-number" id="progress-call-number">Call 1/5</span>
                    <span class="call-title" id="progress-call-title"></span>
                    <span class="call-date" id="progress-call-date"></span>
                </div>
            </div>
        </div>

        <div id="results" class="card results">
            <!-- Results will be inserted here -->
        </div>
    </div>

    <script>
        let currentTab = 'prospect';

        // Initialize button state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const modelSelect = document.getElementById('modelSelect');
            const modelSection = modelSelect ? modelSelect.parentElement : null;
            if (analyzeBtn) analyzeBtn.textContent = 'Get Prospect Overview';
            if (modelSection) modelSection.style.display = 'none';
        });

        function switchTab(tab, evt) {
            currentTab = tab;

            // Update tab buttons
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            const target = (evt && evt.target) || tabButtons[['hypothesis','prospect','demo','gong'].indexOf(tab)];
            if (target) target.classList.add('active');

            // Update tab content
            document.getElementById('gong-tab').classList.toggle('active', tab === 'gong');
            document.getElementById('prospect-tab').classList.toggle('active', tab === 'prospect');
            document.getElementById('demo-tab').classList.toggle('active', tab === 'demo');
            document.getElementById('hypothesis-tab').classList.toggle('active', tab === 'hypothesis');
            
            // Update button text and hide model selector for prospect overview / demo / hypothesis
            const analyzeBtn = document.getElementById('analyzeBtn');
            const modelSelect = document.getElementById('modelSelect');
            const modelSection = modelSelect ? modelSelect.parentElement : null;
            if (tab === 'prospect') {
                if (analyzeBtn) analyzeBtn.textContent = 'Get Prospect Overview';
                if (modelSection) modelSection.style.display = 'none';
            } else if (tab === 'demo') {
                if (analyzeBtn) analyzeBtn.textContent = 'Generate Demo Traces';
                if (modelSection) modelSection.style.display = 'none';
            } else if (tab === 'hypothesis') {
                if (analyzeBtn) analyzeBtn.textContent = 'Research Company';
                if (modelSection) modelSection.style.display = 'none';
            } else {
                if (analyzeBtn) analyzeBtn.textContent = 'Analyze Call';
                if (modelSection) modelSection.style.display = 'block';
            }
        }

        function handleAnalyze() {
            console.log('[Stillness] handleAnalyze called, currentTab=', currentTab);
            if (currentTab === 'prospect') {
                analyzeProspect();
            } else if (currentTab === 'demo') {
                generateDemo();
            } else if (currentTab === 'hypothesis') {
                researchHypothesis();
            } else {
                analyzeTranscript();
            }
        }

        // State for the two-phase demo flow
        let _demoAccountName = '';
        let _demoProjectName = '';
        let _demoModel = '';

        async function generateDemo() {
            const accountName = document.getElementById('demoAccountName').value.trim();
            if (!accountName) {
                alert('Please enter a prospect/account name.');
                return;
            }

            // Save for phase 2
            _demoAccountName = accountName;
            _demoProjectName = document.getElementById('demoProjectName').value.trim() || accountName.toLowerCase().replace(/\s+/g, '-') + '-demo';
            _demoModel = document.getElementById('demoModelSelect').value;

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const confirm = document.getElementById('demo-confirm');
            const loadingMsg = document.getElementById('loading-message');

            loading.style.display = 'block';
            results.style.display = 'none';
            confirm.style.display = 'none';
            loadingMsg.textContent = 'Classifying prospect use case...';

            try {
                const res = await fetch('/api/classify-demo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_name: accountName }),
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.detail || `Classification failed: ${res.status}`);
                }

                const classification = await res.json();
                loading.style.display = 'none';

                // Populate use case dropdown
                const ucSelect = document.getElementById('confirmUseCase');
                ucSelect.innerHTML = '';
                for (const uc of classification.available_use_cases) {
                    const opt = document.createElement('option');
                    opt.value = uc.value;
                    opt.textContent = uc.label;
                    if (uc.value === classification.use_case) opt.selected = true;
                    ucSelect.appendChild(opt);
                }

                // Populate framework dropdown
                const fwSelect = document.getElementById('confirmFramework');
                fwSelect.innerHTML = '';
                for (const fw of classification.available_frameworks) {
                    const opt = document.createElement('option');
                    opt.value = fw.value;
                    opt.textContent = fw.label;
                    if (fw.value === classification.framework) opt.selected = true;
                    fwSelect.appendChild(opt);
                }

                // Show reasoning
                const reasoningEl = document.getElementById('confirm-reasoning');
                reasoningEl.textContent = classification.reasoning || 'Select or confirm the use case and framework for demo generation.';

                // Show whether Gong/CRM data was used (transparency)
                const dataSourcesEl = document.getElementById('confirm-data-sources');
                dataSourcesEl.textContent = classification.data_sources_note || '';
                dataSourcesEl.style.display = classification.data_sources_note ? 'block' : 'none';

                // Show industry if available
                const industryEl = document.getElementById('confirm-industry');
                industryEl.textContent = classification.industry ? `Industry: ${classification.industry}` : '';

                confirm.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<div style="color: red; padding: 20px;"><strong>Error:</strong> ${err.message || 'Classification failed.'}</div>`;
            }
        }

        function cancelDemo() {
            document.getElementById('demo-confirm').style.display = 'none';
        }

        async function confirmAndGenerate() {
            const useCase = document.getElementById('confirmUseCase').value;
            const framework = document.getElementById('confirmFramework').value;

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const confirm = document.getElementById('demo-confirm');
            const loadingMsg = document.getElementById('loading-message');

            confirm.style.display = 'none';
            loading.style.display = 'block';
            results.style.display = 'none';
            loadingMsg.textContent = 'Starting trace generation...';

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000);
                const demoArizeSpaceId = document.getElementById('demoArizeSpaceId').value.trim();
                const demoArizeApiKey = document.getElementById('demoArizeApiKey').value.trim();
                const payload = {
                    account_name: _demoAccountName,
                    project_name: _demoProjectName,
                    model: _demoModel,
                    use_case: useCase,
                    framework: framework,
                };
                if (demoArizeSpaceId) payload.arize_space_id = demoArizeSpaceId;
                if (demoArizeApiKey) payload.arize_api_key = demoArizeApiKey;
                const res = await fetch('/api/generate-demo-stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.detail || `Request failed: ${res.status}`);
                }

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let data = null;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const events = buffer.split(/\n\n+/);
                    buffer = events.pop() || '';
                    for (const chunk of events) {
                        const eventLine = chunk.match(/^event: (\w+)/m);
                        const dataLine = chunk.match(/^data: (.+)/m);
                        if (!eventLine || !dataLine) continue;
                        const event = eventLine[1];
                        const rawData = dataLine[1].trim();
                        try {
                            const parsed = JSON.parse(rawData);
                            if (event === 'progress' && parsed.message) {
                                loadingMsg.textContent = parsed.message;
                            } else if (event === 'done') {
                                data = parsed;
                                break;
                            } else if (event === 'error') {
                                throw new Error(parsed.detail || 'Pipeline failed');
                            }
                        } catch (e) {
                            if (e instanceof SyntaxError) continue;
                            throw e;
                        }
                    }
                    if (data) break;
                }

                loading.style.display = 'none';
                if (!data) {
                    results.style.display = 'block';
                    results.innerHTML = `<div style="color: red; padding: 20px;"><strong>Error:</strong> No response received from server.</div>`;
                    return;
                }

                results.style.display = 'block';
                let html = '<h2>Demo Traces Generated</h2>';
                html += `<div style="padding: 15px; background: #e8f5e9; border-radius: 8px; margin-bottom: 15px;">`;
                html += `<p><strong>Prospect:</strong> ${data.prospect_name}</p>`;
                html += `<p><strong>Industry:</strong> ${data.industry || 'N/A'}</p>`;
                html += `<p><strong>Use Case:</strong> ${data.use_case}</p>`;
                if (data.framework) {
                    html += `<p><strong>Framework:</strong> ${data.framework}</p>`;
                }
                if (data.use_case_reasoning) {
                    html += `<p><strong>Why:</strong> ${data.use_case_reasoning}</p>`;
                }
                html += `<p><strong>Model:</strong> ${data.model_used}</p>`;
                html += `<p><strong>LLM Calls:</strong> ${data.llm_calls_made}</p>`;
                html += `<p><strong>Arize Project:</strong> ${data.project_name}</p>`;
                if (data.arize_url) {
                    html += `<p><a href="${data.arize_url}" target="_blank" rel="noreferrer" style="color: #1976d2; font-weight: bold;">Open in Arize</a></p>`;
                }
                if (data.eval_message != null && data.eval_message !== '') {
                    const evalStyle = data.eval_created ? 'color: #2e7d32;' : 'color: #ed6c02;';
                    html += `<p style="${evalStyle} margin-top: 8px;"><strong>Online evals:</strong> ${String(data.eval_message).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')}</p>`;
                }

                // Download Script button
                if (data.result && data.result.traces_generated > 0) {
                    const scriptParams = new URLSearchParams({
                        use_case: data.use_case,
                        framework: data.framework || 'langgraph',
                        model: data.model_used,
                        project_name: data.project_name,
                    });
                    html += `<p style="margin-top: 10px;"><a href="/api/export-script?${scriptParams.toString()}" download style="display: inline-block; padding: 10px 20px; background: #1976d2; color: white; border-radius: 6px; text-decoration: none; font-weight: 600;">Download Trace Demo Script</a></p>`;
                    html += `<p style="color: #888; font-size: 0.85em; margin-top: 4px;">Standalone .py file for prospects: run it, try a few turns, then open Arize to see how trace data is sent into the platform. Use <code>--batch</code> for 10 synthetic traces.</p>`;
                }
                html += `</div>`;

                if (data.result) {
                    html += `<h3>Pipeline Result</h3>`;
                    html += `<pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 400px;">${JSON.stringify(data.result, null, 2)}</pre>`;
                }

                const errMsg = data.error_message || (data.result && data.result.error);
                const noTraces = data.result && data.result.traces_generated === 0;
                if (noTraces && errMsg) {
                    const safeMsg = String(errMsg).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    html += `<p style="color: #c62828; margin-top: 15px;"><strong>No traces were sent.</strong> ${safeMsg}</p>`;
                } else if (!noTraces) {
                    html += `<p style="color: #666; margin-top: 15px;">Traces were sent to Arize automatically. Open the link above to walk through the demo.</p>`;
                }
                results.innerHTML = html;
            } catch (err) {
                loading.style.display = 'none';
                results.style.display = 'block';
                const isTimeout = err.name === 'AbortError';
                const msg = isTimeout
                    ? 'Request timed out after 10 minutes. The demo pipeline can take several minutes. Please try again.'
                    : (err.message || 'Network error. Please check your connection and try again.');
                results.innerHTML = `<div style="color: red; padding: 20px;"><strong>Error:</strong> ${msg}</div>`;
            }
        }

        async function researchHypothesis() {
            const companyName = document.getElementById('hypCompanyName').value.trim();
            if (!companyName) {
                alert('Please enter a company name.');
                return;
            }
            const domain = document.getElementById('hypDomain').value.trim() || undefined;

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const loadingMsg = document.getElementById('loading-message');

            loading.style.display = 'block';
            results.style.display = 'none';
            loadingMsg.textContent = `AI agent researching ${companyName}... This may take 30-60 seconds.`;

            try {
                const res = await fetch('/api/hypothesis-research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: companyName,
                        company_domain: domain || null,
                    }),
                });

                const data = await res.json();
                loading.style.display = 'none';

                if (!res.ok) {
                    results.style.display = 'block';
                    results.innerHTML = `<div style="color: red; padding: 20px;"><strong>Error:</strong> ${data.detail || JSON.stringify(data)}</div>`;
                    return;
                }

                results.style.display = 'block';
                results.innerHTML = renderHypothesisResults(data);
            } catch (err) {
                loading.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<div style="color: red; padding: 20px;"><strong>Error:</strong> ${err.message}</div>`;
            }
        }

        function renderHypothesisResults(data) {
            const r = data.result;
            const research = r.research || {};
            const hypotheses = r.hypotheses || [];
            const competitive = r.competitive_context || {};
            const reasoning = data.agent_reasoning || [];

            let html = '<h2>ðŸ”¬ Hypothesis Research Results</h2>';

            // Quality badge
            const qualityColors = { high: '#4caf50', medium: '#ff9800', low: '#f44336', insufficient: '#9e9e9e' };
            const quality = r.research_quality || 'unknown';
            html += `<div style="margin-bottom: 15px;"><span style="background: ${qualityColors[quality] || '#9e9e9e'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">Research Quality: ${quality.toUpperCase()}</span></div>`;

            // Warnings
            if (r.warnings && r.warnings.length > 0) {
                html += `<div style="padding: 12px; background: #fff3e0; border-radius: 8px; margin-bottom: 15px;">`;
                r.warnings.forEach(w => { html += `<p style="margin: 4px 0;">âš ï¸ ${w}</p>`; });
                html += `</div>`;
            }

            // Company overview
            html += `<div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">`;
            html += `<h3 style="margin-top: 0;">Company Overview</h3>`;
            html += `<p><strong>Company:</strong> ${research.company_name || r.company_name || ''}</p>`;
            if (research.industry) html += `<p><strong>Industry:</strong> ${research.industry}</p>`;
            if (research.employee_count) html += `<p><strong>Employees:</strong> ${research.employee_count.toLocaleString()}</p>`;
            if (research.ai_ml_confidence) html += `<p><strong>AI/ML Confidence:</strong> ${research.ai_ml_confidence}</p>`;
            if (research.competitive_situation) html += `<p><strong>Competitive Situation:</strong> ${research.competitive_situation}</p>`;
            if (research.company_summary) html += `<p>${research.company_summary}</p>`;
            if (research.ai_ml_signals && research.ai_ml_signals.length > 0) {
                html += `<p style="font-weight: 600; margin-bottom: 8px;">Top Signals:</p>`;
                research.ai_ml_signals.slice(0, 5).forEach(s => {
                    const confColor = { high: '#4caf50', medium: '#ff9800', low: '#f44336' }[s.confidence] || '#9e9e9e';
                    const typeLabel = (s.signal_type || 'signal').replace(/_/g, ' ');
                    const sourceLink = s.source_url ? ` <a href="${s.source_url}" target="_blank" rel="noopener" style="color: #1565c0; font-size: 12px;">View source &rarr;</a>` : '';
                    html += `<div style="padding: 10px 14px; background: white; border-left: 4px solid ${confColor}; border-radius: 0 6px 6px 0; margin-bottom: 8px;">`;
                    html += `<div style="display: flex; gap: 6px; align-items: center; margin-bottom: 4px;">`;
                    html += `<span style="background: #e8eaf6; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${typeLabel}</span>`;
                    html += `<span style="background: ${confColor}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 11px;">${s.confidence}</span>`;
                    html += `</div>`;
                    html += `<span style="font-size: 14px; color: #333;">${s.evidence || ''}</span>${sourceLink}`;
                    html += `</div>`;
                });
            }
            html += `</div>`;

            // Hypotheses
            if (hypotheses.length > 0) {
                html += `<h3>Hypotheses (${hypotheses.length})</h3>`;
                hypotheses.forEach((h, i) => {
                    const confColor = { high: '#4caf50', medium: '#ff9800', low: '#f44336' }[h.confidence] || '#9e9e9e';
                    const valueIcons = { reduce_risk: 'ðŸ›¡ï¸', increase_efficiency: 'âš¡', increase_revenue: 'ðŸ“ˆ', reduce_cost: 'ðŸ’°' };
                    const valueIcon = valueIcons[h.value_category] || 'ðŸ“‹';

                    html += `<div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px;">`;
                    html += `<div style="display: flex; gap: 8px; margin-bottom: 8px;">`;
                    html += `<span style="background: ${confColor}; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">${h.confidence}</span>`;
                    html += `<span style="background: #e8eaf6; padding: 2px 10px; border-radius: 10px; font-size: 12px;">${valueIcon} ${(h.value_category || '').replace(/_/g, ' ')}</span>`;
                    html += `</div>`;
                    html += `<p style="font-weight: 600; font-size: 15px;">${h.hypothesis}</p>`;

                    // Command of the Message
                    if (h.current_state) html += `<p><strong>Current State:</strong> ${h.current_state}</p>`;
                    if (h.future_state) html += `<p><strong>Future State:</strong> ${h.future_state}</p>`;
                    if (h.required_capabilities && h.required_capabilities.length > 0) {
                        html += `<p><strong>Required Capabilities:</strong> ${h.required_capabilities.join(', ')}</p>`;
                    }
                    if (h.negative_consequences) html += `<p><strong>Risk of Inaction:</strong> ${h.negative_consequences}</p>`;

                    // Supporting signals with links
                    if (h.supporting_signals && h.supporting_signals.length > 0) {
                        html += `<div style="margin-top: 10px;"><strong>Supporting Evidence:</strong></div>`;
                        h.supporting_signals.forEach(sig => {
                            const sigConf = { high: '#4caf50', medium: '#ff9800', low: '#f44336' }[sig.confidence] || '#9e9e9e';
                            const sigDesc = sig.description || '';
                            const sigLink = sig.source_url ? ` <a href="${sig.source_url}" target="_blank" rel="noopener" style="color: #1565c0; font-size: 12px;">View source &rarr;</a>` : '';
                            html += `<div style="padding: 6px 10px; background: #f5f5f5; border-left: 3px solid ${sigConf}; border-radius: 0 4px 4px 0; margin: 4px 0; font-size: 13px;">`;
                            html += `${sigDesc}${sigLink}`;
                            html += `</div>`;
                        });
                    }

                    // Discovery questions
                    if (h.discovery_questions && h.discovery_questions.length > 0) {
                        html += `<details style="margin-top: 8px;"><summary style="cursor: pointer; font-weight: 600;">Discovery Questions (${h.discovery_questions.length})</summary>`;
                        html += `<div style="margin-top: 8px;">`;
                        h.discovery_questions.forEach(q => {
                            if (typeof q === 'string') {
                                html += `<div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 6px;">${q}</div>`;
                            } else {
                                html += `<div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 6px;">`;
                                html += `<div style="font-weight: 500;">${q.question || JSON.stringify(q)}</div>`;
                                if (q.rationale) html += `<div style="font-size: 12px; color: #666; margin-top: 4px;">${q.rationale}</div>`;
                                html += `</div>`;
                            }
                        });
                        html += `</div></details>`;
                    }

                    // Similar customers
                    if (h.similar_customers && h.similar_customers.length > 0) {
                        html += `<details style="margin-top: 8px;"><summary style="cursor: pointer; font-weight: 600;">Similar Customers (${h.similar_customers.length})</summary>`;
                        html += `<div style="margin-top: 8px;">`;
                        h.similar_customers.forEach(c => {
                            if (typeof c === 'string') {
                                html += `<div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 6px;">${c}</div>`;
                            } else {
                                html += `<div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 6px;">`;
                                html += `<div style="font-weight: 500;">${c.customer_name || c.name || c.company || 'Unknown'}</div>`;
                                const details = [c.industry, c.use_case].filter(Boolean).join(' &middot; ');
                                if (details) html += `<div style="font-size: 12px; color: #666; margin-top: 2px;">${details}</div>`;
                                if (c.outcome) html += `<div style="font-size: 12px; color: #4caf50; margin-top: 2px;">${c.outcome}</div>`;
                                html += `</div>`;
                            }
                        });
                        html += `</div></details>`;
                    }

                    html += `</div>`;
                });
            }

            // Competitive context
            if (competitive && competitive.situation) {
                html += `<div style="padding: 15px; background: #fce4ec; border-radius: 8px; margin-bottom: 15px;">`;
                html += `<h3 style="margin-top: 0;">Competitive Context</h3>`;
                html += `<p><strong>Situation:</strong> ${competitive.situation.replace(/_/g, ' ')}</p>`;
                if (competitive.detected_competitor) html += `<p><strong>Detected Competitor:</strong> ${competitive.detected_competitor}</p>`;
                if (competitive.positioning) html += `<p style="margin: 10px 0;">${competitive.positioning}</p>`;
                if (competitive.advantages && competitive.advantages.length > 0) {
                    html += `<p style="font-weight: 600; margin-top: 10px;">Advantages:</p><ul style="margin: 4px 0 8px 20px;">`;
                    competitive.advantages.forEach(a => { html += `<li style="margin-bottom: 4px;">${a}</li>`; });
                    html += `</ul>`;
                }
                if (competitive.watch_outs && competitive.watch_outs.length > 0) {
                    html += `<p style="font-weight: 600;">Watch Outs:</p><ul style="margin: 4px 0 8px 20px;">`;
                    competitive.watch_outs.forEach(w => { html += `<li style="margin-bottom: 4px;">${w}</li>`; });
                    html += `</ul>`;
                }
                if (competitive.key_questions && competitive.key_questions.length > 0) {
                    html += `<details style="margin-top: 8px;"><summary style="cursor: pointer; font-weight: 600;">Key Questions (${competitive.key_questions.length})</summary><ul style="margin-top: 6px;">`;
                    competitive.key_questions.forEach(q => { html += `<li style="margin-bottom: 4px;">${q}</li>`; });
                    html += `</ul></details>`;
                }
                html += `</div>`;
            }

            // Agent reasoning
            if (reasoning.length > 0) {
                html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; font-weight: 600;">Agent Reasoning (${reasoning.length} steps)</summary><ol style="margin-top: 8px;">`;
                reasoning.forEach(step => { html += `<li style="margin-bottom: 4px; color: #555;">${step}</li>`; });
                html += `</ol></details>`;
            }

            if (r.processing_time_seconds) {
                html += `<p style="color: #999; margin-top: 15px; font-size: 13px;">Research completed in ${r.processing_time_seconds.toFixed(1)}s</p>`;
            }

            return html;
        }

        // Progress update helper functions
        function updateProgress(data) {
            const progressMessage = document.getElementById('progress-message');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressDetails = document.getElementById('progress-details');
            const progressCallInfo = document.getElementById('progress-call-info');
            const progressCallNumber = document.getElementById('progress-call-number');
            const progressCallTitle = document.getElementById('progress-call-title');
            const progressCallDate = document.getElementById('progress-call-date');

            // Update progress bar
            if (data.progress !== undefined) {
                progressBarFill.style.width = data.progress + '%';
                progressPercentage.textContent = Math.round(data.progress) + '%';
            }

            // Update message
            if (data.message) {
                progressMessage.textContent = data.message;
            }

            // Update details based on stage
            if (data.details) {
                // Show custom details from backend (e.g., "150 calls to check")
                progressDetails.textContent = data.details;
                progressDetails.style.display = 'block';
            } else if (data.total_calls !== undefined) {
                progressDetails.textContent = `Processing ${data.total_calls} calls`;
                progressDetails.style.display = 'block';
            }

            // Show call info when analyzing specific calls
            if (data.current_call !== undefined && data.total_calls !== undefined) {
                progressCallInfo.style.display = 'flex';
                progressCallNumber.textContent = `Call ${data.current_call}/${data.total_calls}`;
                if (data.call_title) {
                    progressCallTitle.textContent = data.call_title;
                }
                if (data.call_date) {
                    progressCallDate.textContent = data.call_date;
                }
            } else if (data.stage === 'searching' || data.stage === 'finalizing') {
                progressCallInfo.style.display = 'none';
            }
        }

        function showProgressLoading() {
            const progressLoading = document.getElementById('progress-loading');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            // Hide regular loading, show progress loading
            loading.style.display = 'none';
            progressLoading.style.display = 'block';
            results.classList.remove('show');

            // Reset progress state
            document.getElementById('progress-bar-fill').style.width = '0%';
            document.getElementById('progress-percentage').textContent = '0%';
            document.getElementById('progress-message').textContent = 'Starting analysis...';
            document.getElementById('progress-details').textContent = '';
            document.getElementById('progress-call-info').style.display = 'none';
        }

        function hideProgressLoading() {
            document.getElementById('progress-loading').style.display = 'none';
        }

        async function analyzeProspect() {
            const accountName = document.getElementById('accountName').value;
            const accountDomain = document.getElementById('accountDomain').value;
            const sfdcAccountId = document.getElementById('sfdcAccountId').value;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            // Validate at least one input is provided
            if (!accountName.trim() && !accountDomain.trim() && !sfdcAccountId.trim()) {
                alert('Please enter at least one search criteria (account name, domain, or Salesforce ID)');
                return;
            }

            // Show loading
            analyzeBtn.disabled = true;
            loading.style.display = 'block';
            document.getElementById('loading-message').textContent = 'Fetching prospect data from BigQuery...';
            results.classList.remove('show');

            // Build request body
            const requestBody = {};
            if (accountName.trim()) {
                requestBody.account_name = accountName.trim();
            }
            if (accountDomain.trim()) {
                requestBody.domain = accountDomain.trim();
            }
            if (sfdcAccountId.trim()) {
                requestBody.sfdc_account_id = sfdcAccountId.trim();
            }

            try {
                const response = await fetch('/api/prospect-overview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to fetch prospect overview');
                }

                const overview = await response.json();
                displayProspectOverview(overview);

            } catch (error) {
                alert('Error: ' + error.message);
                console.error(error);
            } finally {
                analyzeBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayProspectOverview(overview) {
            const results = document.getElementById('results');
            const sf = overview.salesforce;
            const se = overview.sales_engagement;
            const pu = overview.product_usage;
            
            // Helper functions
            const formatCurrency = (value) => {
                if (!value) return 'N/A';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
            };
            
            const formatPercent = (value) => {
                if (value === null || value === undefined) return 'N/A';
                return (value * 100).toFixed(1) + '%';
            };
            
            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                try {
                    return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch { return dateStr; }
            };
            
            const formatMinutes = (mins) => {
                if (!mins) return '0m';
                if (mins < 60) return `${mins}m`;
                const hours = Math.floor(mins / 60);
                const remaining = mins % 60;
                return remaining > 0 ? `${hours}h ${remaining}m` : `${hours}h`;
            };

            // ============================================================================
            // EXECUTIVE SUMMARY
            // ============================================================================
            let summaryHtml = '';
            if (sf) {
                const adoptionStatus = pu?.adoption_status || 'unknown';
                const adoptionColors = {
                    'power_user': '#27ae60',
                    'active': '#3498db',
                    'exploring': '#f39c12',
                    'churning': '#e74c3c',
                    'not_started': '#95a5a6',
                    'unknown': '#7f8c8d'
                };
                const adoptionColor = adoptionColors[adoptionStatus] || '#7f8c8d';
                
                summaryHtml = `
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px; padding: 25px; margin-bottom: 30px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.8em;">${sf.name}</h2>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                                    ${sf.lifecycle_stage ? `<span style="background: #667eea; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">${sf.lifecycle_stage}</span>` : ''}
                                    ${sf.industry ? `<span style="color: #a0a0a0;">${sf.industry}</span>` : ''}
                                    ${sf.website ? `<a href="https://${sf.website.replace(/^https?:\/\//, '')}" target="_blank" style="color: #4facfe; text-decoration: none;">${sf.website.replace(/^https?:\/\//, '')}</a>` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2em; font-weight: bold; color: #27ae60;">${formatCurrency(sf.total_active_arr)}</div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">Active ARR</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 25px;">
                            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold;">${se?.total_calls || 0}</div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">Sales Calls</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold;">${se?.days_in_sales_cycle || 'N/A'}</div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">Days in Cycle</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div style="font-size: 1.8em; font-weight: bold;">${overview.pendo_usage?.unique_visitors || 0}</div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">Platform Users</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                                <div style="font-size: 1.2em; font-weight: bold; color: ${adoptionColor};">${adoptionStatus.replace('_', ' ').toUpperCase()}</div>
                                <div style="font-size: 0.85em; color: #a0a0a0;">Adoption Status</div>
                            </div>
                        </div>
                        
                        ${(sf.assigned_sa || sf.assigned_ai_se || sf.assigned_cse || sf.assigned_csm || sf.owner_name) ? `
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                    <span style="color: #a0a0a0; font-size: 0.85em;">Team:</span>
                                    ${sf.owner_name ? `<span style="background: #0176d3; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">Owner: ${sf.owner_name}</span>` : ''}
                                    ${sf.assigned_sa ? `<span style="background: #667eea; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">SA: ${sf.assigned_sa}</span>` : ''}
                                    ${sf.assigned_ai_se ? `<span style="background: #9b59b6; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">AI SE: ${sf.assigned_ai_se}</span>` : ''}
                                    ${sf.assigned_cse ? `<span style="background: #11998e; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">CSE: ${sf.assigned_cse}</span>` : ''}
                                    ${sf.assigned_csm ? `<span style="background: #4facfe; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;">CSM: ${sf.assigned_csm}</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                summaryHtml = `
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; margin-bottom: 25px; text-align: center; color: #666;">
                        <h3>No Salesforce account found</h3>
                        <p>Try searching with a different account name, domain, or Salesforce ID.</p>
                    </div>
                `;
            }

            // ============================================================================
            // SALES ENGAGEMENT CONTEXT
            // ============================================================================
            let salesEngagementHtml = '';
            if (sf) {
                // Latest Opportunity (featured)
                let latestOppHtml = '';
                const latestOpp = overview.latest_opportunity;
                if (latestOpp) {
                    const stageColor = '#667eea';
                    latestOppHtml = `
                        <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%); border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <div style="font-size: 0.85em; color: #667eea; font-weight: 600; margin-bottom: 5px;">CURRENT OPPORTUNITY</div>
                                    <h4 style="margin: 0 0 8px 0; color: #333;">${latestOpp.name}</h4>
                                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                        <span style="background: ${stageColor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">${latestOpp.stage_name}</span>
                                        <span style="color: #666;">Close: ${formatDate(latestOpp.close_date)}</span>
                                        ${latestOpp.owner_name ? `<span style="color: #666;">Owner: ${latestOpp.owner_name}</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: #27ae60;">${formatCurrency(latestOpp.amount)}</div>
                                    <div style="font-size: 0.85em; color: #666;">${latestOpp.probability || 0}% probability</div>
                                </div>
                            </div>
                            ${latestOpp.next_step ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #d0d8e8;">
                                    <strong style="color: #555;">Next Step:</strong> <span style="color: #333;">${latestOpp.next_step}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // All Opportunities (collapsible)
                let allOppsHtml = '';
                if (overview.all_opportunities && overview.all_opportunities.length > 0) {
                    const oppsRows = overview.all_opportunities.map(opp => {
                        const stageColor = opp.is_won ? '#27ae60' : (opp.is_closed ? '#e74c3c' : '#667eea');
                        return `
                            <tr style="border-bottom: 1px solid #e9ecef;">
                                <td style="padding: 10px 14px;">
                                    <div style="font-weight: 500;">${opp.name}</div>
                                    ${opp.owner_name ? `<div style="font-size: 0.8em; color: #888;">${opp.owner_name}</div>` : ''}
                                </td>
                                <td style="padding: 10px 14px;"><span style="background: ${stageColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">${opp.stage_name}</span></td>
                                <td style="padding: 10px 14px; font-weight: 500;">${formatCurrency(opp.amount)}</td>
                                <td style="padding: 10px 14px; font-size: 0.9em;">${formatDate(opp.close_date)}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    allOppsHtml = `
                        <details style="margin-bottom: 25px;">
                            <summary style="cursor: pointer; color: #667eea; font-weight: 600; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                View All Opportunities (${overview.all_opportunities.length})
                            </summary>
                            <div style="margin-top: 10px; overflow-x: auto; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
                                <table style="width: 100%; border-collapse: collapse; background: white; font-size: 0.9em;">
                                    <thead style="background: #f1f3f9; color: #555;">
                                        <tr>
                                            <th style="padding: 10px 14px; text-align: left;">Opportunity</th>
                                            <th style="padding: 10px 14px; text-align: left;">Stage</th>
                                            <th style="padding: 10px 14px; text-align: left;">Amount</th>
                                            <th style="padding: 10px 14px; text-align: left;">Close Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>${oppsRows}</tbody>
                                </table>
                            </div>
                        </details>
                    `;
                }
                
                // Deal Summary from Gong Analysis
                let dealSummaryHtml = '';
                const ds = se?.deal_summary;
                if (ds && ds.current_state) {
                    const sentimentColor = {
                        'positive': '#27ae60',
                        'neutral': '#f39c12',
                        'concerned': '#e74c3c'
                    }[ds.champion_sentiment] || '#7f8c8d';
                    
                    dealSummaryHtml = `
                        <div style="background: #fafbfc; border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #667eea;">
                            <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                Deal Summary 
                                ${ds.champion_sentiment ? `<span style="background: ${sentimentColor}; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.75em;">${ds.champion_sentiment}</span>` : ''}
                            </h4>
                            <p style="margin: 0 0 15px 0; color: #444; line-height: 1.6;">${ds.current_state}</p>
                            
                            ${ds.blockers_identified && ds.blockers_identified.length > 0 ? `
                                <div style="background: #fff3cd; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <strong style="color: #856404;">Blockers/Concerns:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #856404;">
                                        ${ds.blockers_identified.map(b => `<li style="margin-bottom: 4px;">${b}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${ds.risk_factors && ds.risk_factors.length > 0 ? `
                                <div style="background: #f8d7da; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                    <strong style="color: #721c24;">Risk Factors:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #721c24;">
                                        ${ds.risk_factors.map(r => `<li style="margin-bottom: 4px;">${r}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${ds.next_steps_from_calls && ds.next_steps_from_calls.length > 0 ? `
                                <div style="background: #d4edda; border-radius: 8px; padding: 12px;">
                                    <strong style="color: #155724;">Next Steps from Calls:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #155724;">
                                        ${ds.next_steps_from_calls.slice(0, 3).map(n => `<li style="margin-bottom: 4px;">${n}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Gong Calls section - simplified to just key stats and themes
                let gongHtml = '';
                if (overview.gong_summary && overview.gong_summary.total_calls > 0) {
                    const gs = overview.gong_summary;
                    
                    // Key themes
                    const themesHtml = gs.key_themes && gs.key_themes.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #555; margin-right: 8px;">Topics:</strong>
                            ${gs.key_themes.map(t => `<span style="background: #e8f0fe; color: #1967d2; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; margin-right: 8px; margin-bottom: 8px; display: inline-block;">${t}</span>`).join('')}
                        </div>
                    ` : '';
                    
                    // Get date range
                    const recentCalls = gs.recent_calls || [];
                    const dates = recentCalls.map(c => c.call_date).filter(d => d).sort();
                    const dateRange = dates.length > 1 
                        ? `${formatDate(dates[dates.length - 1])} - ${formatDate(dates[0])}`
                        : dates.length === 1 ? formatDate(dates[0]) : '';
                    
                    gongHtml = `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: #333; font-size: 1em;">
                                    Engagement Metrics
                                </h4>
                                <span style="font-size: 0.85em; color: #666;">${gs.total_calls} calls â€¢ ${Math.round(gs.total_duration_minutes || 0)} min${dateRange ? ` â€¢ ${dateRange}` : ''}</span>
                            </div>
                            
                            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                                <div>
                                    <span style="font-size: 1.3em; font-weight: bold; color: #667eea;">${formatPercent(gs.avg_talk_ratio)}</span>
                                    <span style="font-size: 0.8em; color: #666; margin-left: 4px;">talk ratio</span>
                                </div>
                                <div>
                                    <span style="font-size: 1.3em; font-weight: bold; color: #11998e;">${gs.avg_interactivity?.toFixed(1) || 'N/A'}</span>
                                    <span style="font-size: 0.8em; color: #666; margin-left: 4px;">interactivity</span>
                                </div>
                                <div>
                                    <span style="font-size: 1.3em; font-weight: bold; color: #4facfe;">${gs.days_since_last_call ?? 'N/A'}</span>
                                    <span style="font-size: 0.8em; color: #666; margin-left: 4px;">days since last call</span>
                                </div>
                            </div>
                            
                            ${themesHtml}
                        </div>
                    `;
                }
                
                salesEngagementHtml = `
                    <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                        <h3 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #667eea; color: #333;">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Sales Engagement Context</span>
                        </h3>
                        ${latestOppHtml}
                        ${dealSummaryHtml}
                        ${allOppsHtml}
                        ${gongHtml}
                    </div>
                `;
            }

            // ============================================================================
            // PRODUCT USAGE PATTERNS
            // ============================================================================
            let productUsageHtml = '';
            if (overview.pendo_usage && overview.pendo_usage.total_events > 0) {
                const pendo = overview.pendo_usage;
                
                // Recent visitors (who last used it)
                let visitorsHtml = '';
                if (pendo.recent_visitors && pendo.recent_visitors.length > 0) {
                    const totalUsers = pendo.unique_visitors || pendo.recent_visitors.length;
                    const shownUsers = pendo.recent_visitors.length;
                    const visitorItems = pendo.recent_visitors.map(v => `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px;">
                                <div style="font-weight: 500;">${v.display_name || v.email || v.visitor_id}</div>
                            </td>
                            <td style="padding: 12px;">${formatDate(v.last_visit)}</td>
                            <td style="padding: 12px;">${formatMinutes(v.total_minutes)}</td>
                            <td style="padding: 12px;">${v.total_events.toLocaleString()} events</td>
                            <td style="padding: 12px;">${v.visit_count} visits</td>
                        </tr>
                    `).join('');
                    
                    const showingNote = totalUsers > shownUsers 
                        ? `<span style="font-size: 13px; color: #666; font-weight: normal;">(showing ${shownUsers} most recent of ${totalUsers} total users active in last 90 days)</span>`
                        : '';
                    
                    visitorsHtml = `
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 15px; color: #333;">Who's Using the Platform ${showingNote}</h4>
                            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <table style="width: 100%; border-collapse: collapse; background: white;">
                                    <thead style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">User</th>
                                            <th style="padding: 12px; text-align: left;">Last Active</th>
                                            <th style="padding: 12px; text-align: left;">Time on Platform</th>
                                            <th style="padding: 12px; text-align: left;">Activity</th>
                                            <th style="padding: 12px; text-align: left;">Visits</th>
                                        </tr>
                                    </thead>
                                    <tbody>${visitorItems}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Feature definitions mapping - expanded for common Arize features
                const featureDefinitions = {
                    'Query Filters': 'Filtering and searching through trace/span data',
                    'Query filters': 'Filtering and searching through trace/span data',
                    'Trace View': 'Viewing detailed traces of LLM/ML operations',
                    'Dashboard': 'Main analytics dashboard with metrics overview',
                    'Projects': 'Organizing work into separate project spaces',
                    'Datasets': 'Managing evaluation and training datasets',
                    'Experiments': 'Running and comparing model experiments',
                    'Evaluations': 'Testing model quality with eval tasks',
                    'Prompts': 'Managing and versioning prompt templates',
                    'Spans': 'Individual operation tracking within traces',
                    'Annotations': 'Adding labels and feedback to data',
                    'Monitors': 'Setting up alerts and monitoring rules',
                    'Embeddings': 'Visualizing and analyzing vector embeddings',
                    'Model Performance': 'Tracking model accuracy and metrics',
                    'Model Tabs': 'Navigating between model configuration views',
                    'Config': 'Model configuration and settings',
                    'Performance': 'Analyzing model performance metrics',
                    'worst performing': 'Identifying low-performing data segments',
                    'slices': 'Data segments grouped by attributes',
                    'baseline': 'Reference model for performance comparison',
                    'Cost Analysis': 'Monitoring API costs and token usage',
                    'Comparisons': 'Side-by-side model/version comparisons',
                    'Export': 'Exporting data for external analysis',
                    'Inferences': 'Viewing individual model predictions',
                    'Sessions': 'User session and conversation tracking',
                    'AI Search': 'Natural language search across platform data',
                    'Search Input': 'Searching through traces, spans, or data',
                    'Configure': 'Setting up model or project configuration',
                    'Drift': 'Detecting changes in data distribution over time',
                    'Data Quality': 'Monitoring data integrity and completeness',
                    'Playground': 'Interactive environment for testing prompts',
                    'Traces': 'End-to-end request/response tracking',
                    'LLM': 'Large Language Model monitoring features'
                };
                
                // Helper to get feature description
                const getFeatureDescription = (featureName) => {
                    if (!featureName) return null;
                    // Try exact match first
                    if (featureDefinitions[featureName]) return featureDefinitions[featureName];
                    // Try partial match
                    const lowerName = featureName.toLowerCase();
                    for (const [key, desc] of Object.entries(featureDefinitions)) {
                        if (lowerName.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerName)) {
                            return desc;
                        }
                    }
                    return null;
                };
                
                // Top features
                let featuresHtml = '';
                if (pendo.top_features && pendo.top_features.length > 0) {
                    const featureItems = pendo.top_features.slice(0, 8).map(f => {
                        const name = f.feature_name || f.feature_id;
                        const description = getFeatureDescription(name);
                        return `
                            <div style="padding: 12px 14px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 500;">${name}</span>
                                    <div style="display: flex; gap: 15px; font-size: 0.9em; color: #666;">
                                        <span>${f.event_count.toLocaleString()} uses</span>
                                        <span>${f.unique_users} users</span>
                                    </div>
                                </div>
                                ${description ? `<div style="font-size: 0.85em; color: #888; margin-top: 4px;">${description}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    featuresHtml = `
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 15px; color: #333;">Top Features Used</h4>
                            ${featureItems}
                        </div>
                    `;
                }
                
                // Weekly trend visualization
                let trendHtml = '';
                if (pendo.weekly_trend && pendo.weekly_trend.length > 0) {
                    const maxEvents = Math.max(...pendo.weekly_trend.map(w => w.events || 0));
                    const bars = pendo.weekly_trend.slice(0, 8).reverse().map(w => {
                        const height = maxEvents > 0 ? Math.max(10, (w.events / maxEvents) * 100) : 10;
                        const weekLabel = w.week_start ? new Date(w.week_start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                        return `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <div style="width: 100%; max-width: 40px; height: ${height}px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px 4px 0 0;"></div>
                                <div style="font-size: 0.7em; color: #666; white-space: nowrap;">${weekLabel}</div>
                            </div>
                        `;
                    }).join('');
                    
                    trendHtml = `
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 15px; color: #333;">Usage Trend (Last 8 Weeks)</h4>
                            <div style="display: flex; align-items: flex-end; height: 120px; gap: 8px; padding: 10px; background: #f8f9fa; border-radius: 12px;">
                                ${bars}
                            </div>
                        </div>
                    `;
                }
                
                productUsageHtml = `
                    <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                        <h3 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #ff6b6b; color: #333;">
                            <span style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Product Usage Patterns</span>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${pendo.unique_visitors}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Total Users</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${pendo.active_days_last_7 || 0}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Active Days (7d)</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;">${formatMinutes(pendo.total_minutes)}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Time on Platform</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 1.3em; font-weight: bold;">${pendo.days_since_last_activity ?? 'N/A'}</div>
                                <div style="font-size: 0.85em; opacity: 0.9;">Days Since Last Use</div>
                            </div>
                        </div>
                        
                        ${trendHtml}
                        ${visitorsHtml}
                        ${featuresHtml}
                    </div>
                `;
            }
            
            // ============================================================================
            // NEXT STEPS - Extracted to show prominently at the top
            // ============================================================================
            let nextStepsHtml = '';
            const ub_for_next_steps = overview.user_behavior;
            if (ub_for_next_steps && ub_for_next_steps.recommendations) {
                const nextStepsRec = ub_for_next_steps.recommendations.find(r => r.category === 'Next Steps');
                if (nextStepsRec && nextStepsRec.steps && nextStepsRec.steps.length > 0) {
                    nextStepsHtml = `
                        <div style="background: linear-gradient(135deg, #00bcd4 0%, #00acc1 100%); border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,188,212,0.3);">
                            <h3 style="margin: 0 0 15px 0; color: white; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.4em;">âœ…</span>
                                <span>Recommended Actions</span>
                            </h3>
                            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px;">
                                <ol style="margin: 0; padding-left: 25px;">
                                    ${nextStepsRec.steps.map(step => `
                                        <li style="margin-bottom: 12px; color: #00695c; font-size: 1.05em; line-height: 1.5;">
                                            ${step}
                                        </li>
                                    `).join('')}
                                </ol>
                            </div>
                        </div>
                    `;
                }
            }
            
            // User Behavior Analysis section
            let userBehaviorHtml = '';
            const ub = overview.user_behavior;
            if (ub) {
                const engagementColors = {
                    'high': '#27ae60',
                    'medium': '#f39c12',
                    'low': '#e74c3c',
                    'unknown': '#7f8c8d'
                };
                const engagementColor = engagementColors[ub.engagement_level] || '#7f8c8d';
                
                // Build issues section with recording links
                let issuesHtml = '';
                if (ub.issues_summary || (ub.user_issues && ub.user_issues.length > 0)) {
                    const issueTypeIcons = {
                        'dead_click': 'ðŸ–±ï¸',
                        'error': 'âš ï¸',
                        'frustrated': 'ðŸ˜¤',
                        'unknown': 'â“'
                    };
                    
                    const issueItems = (ub.user_issues || []).slice(0, 8).map(issue => {
                        const icon = issueTypeIcons[issue.issue_type] || 'â“';
                        const typeLabel = issue.issue_type === 'dead_click' ? 'Dead Click' : 
                                         issue.issue_type === 'error' ? 'Error' :
                                         issue.issue_type === 'frustrated' ? 'Frustrated' : issue.issue_type;
                        return `
                            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0;">
                                <span style="font-size: 1.3em;">${icon}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                        <span style="font-weight: 600; color: #333;">${typeLabel}</span>
                                        ${issue.recording_url ? `<a href="${issue.recording_url}" target="_blank" style="background: #6c5ce7; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; text-decoration: none;">View Recording</a>` : ''}
                                    </div>
                                    <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                                        ${issue.page_context ? `<strong>${issue.page_context}</strong> â€¢ ` : ''}
                                        ${issue.user_email || 'Unknown user'}
                                    </div>
                                    <div style="font-size: 0.8em; color: #999; margin-top: 2px;">
                                        ${issue.timestamp ? new Date(issue.timestamp).toLocaleString() : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    issuesHtml = `
                        <div style="background: #fff8e6; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #f39c12;">
                            <h4 style="margin: 0 0 12px 0; color: #8a6914; font-size: 1em;">User Experience Issues Detected</h4>
                            ${ub.issues_summary ? `<p style="margin: 0 0 15px 0; color: #6b5210; line-height: 1.5; font-size: 0.95em;">${ub.issues_summary}</p>` : ''}
                            ${issueItems ? `
                                <details style="margin-top: 10px;" open>
                                    <summary style="cursor: pointer; color: #8a6914; font-weight: 600; margin-bottom: 10px;">View Issue Details with FullStory Recordings</summary>
                                    ${issueItems}
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Build adoption milestones section
                let milestonesHtml = '';
                if (ub.adoption_milestones && ub.adoption_milestones.length > 0) {
                    const milestoneItems = ub.adoption_milestones.map(m => {
                        const statusIcon = m.completed ? 'âœ…' : 'â¬œ';
                        const statusColor = m.completed ? '#27ae60' : '#bdc3c7';
                        const countText = m.completed && m.count > 0 ? ` (${m.count}x)` : '';
                        const dateText = m.completed && m.last_date ? ` â€¢ Last: ${m.last_date}` : '';
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${m.completed ? '#e8f8f0' : '#f8f9fa'}; border-radius: 8px; border-left: 3px solid ${statusColor};">
                                <span style="font-size: 1.1em;">${statusIcon}</span>
                                <div style="flex: 1;">
                                    <span style="font-weight: 500; color: ${m.completed ? '#27ae60' : '#7f8c8d'};">${m.name}</span>
                                    ${m.completed ? `<span style="font-size: 0.85em; color: #888;">${countText}${dateText}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    milestonesHtml = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; color: #333; font-size: 1em;">Adoption Milestones</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                ${milestoneItems}
                            </div>
                        </div>
                    `;
                }
                
                userBehaviorHtml = `
                    <div style="background: white; border-radius: 16px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                        <h3 style="margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #6c5ce7; color: #333;">
                            <span style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">User Behavior Analysis</span>
                            <span style="background: ${engagementColor}; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.6em; margin-left: 10px; vertical-align: middle;">${ub.engagement_level.toUpperCase()} ENGAGEMENT</span>
                        </h3>
                        
                        ${milestonesHtml}
                        
                        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 1em;">What Users Are Doing</h4>
                            <p style="margin: 0; color: #555; line-height: 1.6;">${ub.summary}</p>
                        </div>
                        
                        ${ub.hypothesis ? `
                            <div style="background: #e8f4fd; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                                <h4 style="margin: 0 0 10px 0; color: #2980b9; font-size: 1em;">Hypothesis: What They're Trying to Accomplish</h4>
                                <p style="margin: 0; color: #34495e; line-height: 1.6;">${ub.hypothesis}</p>
                            </div>
                        ` : ''}
                        
                        ${ub.key_workflows_used && ub.key_workflows_used.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; color: #333; font-size: 1em;">Key Workflows Used</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${ub.key_workflows_used.map(w => `<span style="background: #e8f0fe; color: #1967d2; padding: 6px 14px; border-radius: 20px; font-size: 0.9em;">${w}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${issuesHtml}
                        
                        ${ub.critical_issues && ub.critical_issues.length > 0 ? `
                            <div style="background: #ffeaea; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                                <h4 style="margin: 0 0 12px 0; color: #c0392b; font-size: 1em;">Critical Issues</h4>
                                ${ub.critical_issues.map(issue => `
                                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                        <strong style="color: #e74c3c;">${issue.type}:</strong>
                                        <span style="color: #555;">${issue.description}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${ub.recommendations && ub.recommendations.filter(r => r.category !== 'Next Steps').length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 1.1em;">ðŸ“‹ Actionable Recommendations</h4>
                                ${ub.recommendations.filter(r => r.category !== 'Next Steps').map(rec => {
                                    if (typeof rec === 'string') {
                                        // Legacy string format
                                        return `<div style="background: #e8f5e9; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #27ae60;">
                                            <span style="color: #2e7d32;">${rec}</span>
                                        </div>`;
                                    }
                                    
                                    // New structured format
                                    const categoryColors = {
                                        'Re-engagement': { bg: '#fff3e0', border: '#ff9800', icon: 'ðŸ”„' },
                                        'Expansion': { bg: '#e3f2fd', border: '#2196f3', icon: 'ðŸ“ˆ' },
                                        'Deepening': { bg: '#f3e5f5', border: '#9c27b0', icon: 'ðŸŽ¯' },
                                        'Competitive': { bg: '#fce4ec', border: '#e91e63', icon: 'âš”ï¸' },
                                        'Internal Resources': { bg: '#e8f5e9', border: '#4caf50', icon: 'ðŸ‘¥' },
                                        'Next Steps': { bg: '#e0f7fa', border: '#00bcd4', icon: 'âœ…' }
                                    };
                                    const style = categoryColors[rec.category] || { bg: '#f5f5f5', border: '#9e9e9e', icon: 'ðŸ’¡' };
                                    
                                    let content = '';
                                    
                                    if (rec.category === 'Competitive' && rec.competitive_messaging) {
                                        content = rec.competitive_messaging.map((cm, idx) => {
                                            const mentionedIn = cm.mentioned_in && cm.mentioned_in.length > 0
                                                ? `<div style="font-size: 0.8em; color: #888; margin-bottom: 8px;">
                                                    ðŸ“ž Mentioned in: ${cm.mentioned_in.slice(0, 3).join(', ')}${cm.mention_count > 3 ? ` (+${cm.mention_count - 3} more)` : ''}
                                                   </div>`
                                                : '';
                                            // Show note if present (e.g., for LangChain -> LangSmith clarification)
                                            const noteSection = cm.note
                                                ? `<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9em;">
                                                    ${cm.note}
                                                   </div>`
                                                : '';
                                            
                                            // What they said section (new targeted analysis)
                                            const whatTheySaidSection = cm.what_they_said && cm.what_they_said !== 'No specific mentions captured' && cm.what_they_said !== 'See context below'
                                                ? `<div style="background: #e3f2fd; border-left: 3px solid #1976d2; padding: 10px; border-radius: 0 6px 6px 0; margin-bottom: 12px;">
                                                    <div style="font-weight: 600; color: #1565c0; font-size: 0.85em; margin-bottom: 4px;">ðŸŽ¯ What They're Interested In:</div>
                                                    <div style="color: #333; font-size: 0.9em;">${cm.what_they_said}</div>
                                                   </div>`
                                                : '';
                                            
                                            // Targeted response section (main actionable content)
                                            const targetedResponseSection = cm.targeted_response
                                                ? `<div style="background: #e8f5e9; border: 1px solid #4caf50; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                                    <div style="font-weight: 600; color: #2e7d32; font-size: 0.85em; margin-bottom: 6px;">ðŸ’¬ Recommended Response:</div>
                                                    <div style="color: #1b5e20; font-size: 0.95em; line-height: 1.5;">${cm.targeted_response}</div>
                                                   </div>`
                                                : '';
                                            
                                            // Raw context section (expandable for transparency)
                                            const rawContextsSection = cm.raw_contexts && cm.raw_contexts.length > 0
                                                ? `<details style="margin-bottom: 10px;">
                                                    <summary style="cursor: pointer; font-size: 0.8em; color: #666; padding: 4px;">ðŸ“ See exact quotes from calls (${cm.raw_contexts.length})</summary>
                                                    <div style="background: #fafafa; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 0.8em; color: #555;">
                                                        ${cm.raw_contexts.map(ctx => `<div style="margin-bottom: 8px; padding-left: 8px; border-left: 2px solid #ddd;">${ctx}</div>`).join('')}
                                                    </div>
                                                   </details>`
                                                : '';
                                            
                                            // Generic differentiator as fallback (collapsible)
                                            const genericFallbackSection = cm.differentiator
                                                ? `<details style="margin-top: 8px;">
                                                    <summary style="cursor: pointer; font-size: 0.8em; color: #888; padding: 4px;">ðŸ“š Generic positioning (backup)</summary>
                                                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 6px;">
                                                        <div style="font-size: 0.85em; color: #555; margin-bottom: 8px;">${cm.differentiator}</div>
                                                        <div style="background: #fff8e1; padding: 8px; border-radius: 4px; font-size: 0.8em;">
                                                            <strong>Generic Talking Point:</strong> ${cm.talking_point}
                                                        </div>
                                                    </div>
                                                   </details>`
                                                : '';
                                            
                                            return `
                                            <div style="background: white; border-radius: 6px; padding: 14px; margin-top: 10px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                                                <div style="font-weight: 600; color: #c62828; margin-bottom: 6px; font-size: 1.05em;">âš”ï¸ vs ${cm.competitor}</div>
                                                ${mentionedIn}
                                                ${noteSection}
                                                ${whatTheySaidSection}
                                                ${targetedResponseSection}
                                                ${rawContextsSection}
                                                ${genericFallbackSection}
                                            </div>
                                        `}).join('');
                                    } else if (rec.category === 'Internal Resources' && rec.contacts) {
                                        content = `
                                            <div style="margin-top: 8px;">${rec.description || ''}</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                                ${rec.contacts.map(c => `
                                                    <a href="mailto:${c.email}" style="background: white; border: 1px solid #4caf50; padding: 6px 12px; border-radius: 20px; text-decoration: none; color: #2e7d32; font-size: 0.9em;">
                                                        ${c.name} <span style="color: #888;">âœ‰ï¸</span>
                                                    </a>
                                                `).join('')}
                                            </div>
                                        `;
                                    } else if (rec.category === 'Next Steps' && rec.steps) {
                                        content = `
                                            <ol style="margin: 10px 0 0 20px; padding: 0;">
                                                ${rec.steps.map(step => `<li style="margin-bottom: 6px; color: #00838f;">${step}</li>`).join('')}
                                            </ol>
                                        `;
                                    } else if (rec.description) {
                                        content = `<div style="margin-top: 6px; color: #555; font-size: 0.95em;">${rec.description}</div>`;
                                    }
                                    
                                    return `
                                        <div style="background: ${style.bg}; border-radius: 10px; padding: 15px; margin-bottom: 12px; border-left: 4px solid ${style.border};">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="font-size: 1.2em;">${style.icon}</span>
                                                <span style="font-weight: 600; color: #333;">${rec.title || rec.category}</span>
                                                <span style="background: ${style.border}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">${rec.category}</span>
                                            </div>
                                            ${content}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Data sources and errors
            const sourcesHtml = overview.data_sources_available.map(src => 
                `<span style="background: #27ae60; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; margin-right: 6px;">${src}</span>`
            ).join('');

            const errorsHtml = overview.errors && overview.errors.length > 0 ? `
                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Note:</strong> ${overview.errors.join('; ')}
                </div>
            ` : '';

            results.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <span style="color: #666;">Searched by ${overview.lookup_method}: </span>
                    <strong>${overview.lookup_value}</strong>
                    <span style="margin-left: 20px; color: #666;">Sources: </span>${sourcesHtml}
                </div>
                ${errorsHtml}
                ${nextStepsHtml}
                ${summaryHtml}
                ${salesEngagementHtml}
                ${productUsageHtml}
                ${userBehaviorHtml}
            `;

            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth' });
        }

        async function analyzeTranscript() {
            console.log('[Stillness] analyzeTranscript called, currentTab=', currentTab);
            try {
            const gongUrl = (document.getElementById('gongUrl') || {}).value || '';
            const transcriptEl = document.getElementById('transcript');
            const transcript = transcriptEl ? transcriptEl.value : '';
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            // Validate input based on current tab
            if (currentTab === 'gong' && !gongUrl.trim()) {
                alert('Please paste a Gong URL first');
                return;
            }

            if (currentTab === 'manual' && !transcript.trim()) {
                alert('Please paste a transcript first');
                return;
            }

            // Show loading with appropriate message
            if (analyzeBtn) analyzeBtn.disabled = true;
            if (loading) loading.style.display = 'block';
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) {
                loadingMsg.textContent = currentTab === 'gong' ? 'Fetching transcript from Gong API...' : 'Analyzing transcript...';
            }
            if (results) results.classList.remove('show');

            // Get selected model
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o';

            // Build request body based on current tab
            const requestBody = {
                sa_name: null,  // Auto-detect from transcript
                model: selectedModel  // Pass selected model to API
            };

            if (currentTab === 'gong') {
                requestBody.gong_url = gongUrl;
            } else {
                requestBody.transcript = transcript;
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 240000);
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                const msg = error.name === 'AbortError' ? 'Request timed out after 4 minutes. Try a faster model (GPT-4o Mini) or shorter transcript.' : (error.message || String(error));
                alert('Error: ' + msg);
                console.error('Analyze error:', error);
            } finally {
                if (analyzeBtn) analyzeBtn.disabled = false;
                if (loading) loading.style.display = 'none';
            }
            } catch (err) {
                alert('Unexpected error: ' + (err.message || String(err)));
                console.error('Analyze transcript error:', err);
                const ab = document.getElementById('analyzeBtn');
                const ld = document.getElementById('loading');
                if (ab) ab.disabled = false;
                if (ld) ld.style.display = 'none';
            }
        }

        function displayResults(data) {
            const results = document.getElementById('results');

            const severityColors = {
                'critical': '#e74c3c',
                'important': '#f39c12',
                'minor': '#3498db'
            };

            const insightsHtml = data.top_insights.map(insight => `
                <div class="insight ${insight.severity}">
                    <div class="insight-header">
                        <span class="insight-category">${insight.category}</span>
                        ${insight.timestamp ? `<span class="insight-timestamp">${insight.timestamp}</span>` : ''}
                    </div>
                    ${insight.conversation_snippet ? `
                        <div class="conversation-snippet">
                            <strong>ðŸ“ Conversation:</strong>
                            <pre>${insight.conversation_snippet}</pre>
                        </div>
                    ` : ''}
                    <div class="insight-section">
                        <strong>What Happened:</strong>
                        ${insight.what_happened}
                    </div>
                    <div class="insight-section">
                        <strong>Why It Matters:</strong>
                        ${insight.why_it_matters}
                    </div>
                    <div class="insight-section">
                        <strong>Better Approach:</strong>
                        ${insight.better_approach}
                    </div>
                    ${insight.example_phrasing ? `
                        <div class="example-phrasing">
                            <strong>Example: </strong>"${insight.example_phrasing}"
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Build classification HTML
            const classificationHtml = buildClassificationHtml(data.call_classification);

            results.innerHTML = `
                ${data.recap_data ? `
                <div class="recap-section" style="margin-bottom: 25px;">
                    <h3>ðŸ“Š Recap Slide Deck</h3>
                    <p style="margin-bottom: 15px; color: #666;">
                        Download a <strong>two-slide PowerPoint deck</strong> with a recap of the conversation and probing questions for your next call.
                    </p>
                    <button class="btn-recap" id="generateRecapBtn" onclick="generateRecapSlide()">
                        ðŸ“¥ Download Recap Slides (.pptx)
                    </button>
                    <p id="recapStatus" style="margin-top: 10px; display: none;"></p>
                </div>
                ` : ''}

                ${classificationHtml}

                <h2>${data.call_summary}</h2>

                <h3 class="section-title">Top Actionable Insights</h3>
                ${insightsHtml}

                <h3 class="section-title">Strengths</h3>
                <ul class="list">
                    ${data.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>

                <h3 class="section-title">Areas for Improvement</h3>
                <ul class="list improvement-list">
                    ${data.improvement_areas.map(a => `<li>${a}</li>`).join('')}
                </ul>

                <h3 class="section-title">Key Moments</h3>
                <ul class="list">
                    ${data.key_moments.map(m => `<li><strong>${m.timestamp}</strong>: ${m.description}</li>`).join('')}
                </ul>
            `;
            
            // Store recap data for later use
            window.currentRecapData = data.recap_data;

            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function generateRecapSlide() {
            const btn = document.getElementById('generateRecapBtn');
            const status = document.getElementById('recapStatus');
            
            if (!window.currentRecapData) {
                alert('No recap data available. Please analyze a call first.');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'â³ Generating...';
            status.style.display = 'block';
            status.textContent = 'Creating your PowerPoint presentation...';
            status.style.color = '#666';
            
            try {
                const response = await fetch('/api/generate-recap-slide', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(window.currentRecapData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate recap slide');
                }
                
                // Get the blob and download it
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'Recap_Slide.pptx';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                status.innerHTML = `âœ… PowerPoint downloaded! Open it in PowerPoint, Google Slides, or Keynote.`;
                status.style.color = '#27ae60';
                
                btn.textContent = 'ðŸ“¥ Download Recap Slide (.pptx)';
                btn.disabled = false;
                
            } catch (error) {
                status.textContent = 'âŒ Error: ' + error.message;
                status.style.color = '#e74c3c';
                btn.textContent = 'ðŸ“¥ Download Recap Slide (.pptx)';
                btn.disabled = false;
            }
        }

        function buildEvidenceHtml(evidence) {
            if (!evidence || evidence.length === 0) return '';
            
            return evidence.map(e => `
                <div class="evidence-item">
                    ${e.timestamp ? `<span class="timestamp-badge">${e.timestamp}</span>` : ''}
                    <strong>${e.criteria_name.replace(/_/g, ' ')}</strong>
                    ${e.speaker ? ` - ${e.speaker}` : ''}
                    ${e.conversation_snippet ? `<div class="snippet">${e.conversation_snippet}</div>` : ''}
                </div>
            `).join('');
        }

        function buildMissedOpportunitiesHtml(opportunities) {
            if (!opportunities || opportunities.length === 0) return '';
            
            return opportunities.map(o => `
                <div class="missed-opportunity-item">
                    ${o.timestamp ? `<span class="timestamp-badge">${o.timestamp}</span>` : ''}
                    <strong>Missed: ${o.criteria_name.replace(/_/g, ' ')}</strong>
                    <div style="margin-top: 6px;">${o.context}</div>
                    <div class="suggested-question">
                        ðŸ’¬ "${o.suggested_question}"
                    </div>
                    <div class="why-important">
                        <strong>Why:</strong> ${o.why_important}
                    </div>
                </div>
            `).join('');
        }

        function countCriteriaStatus(criteriaObj) {
            // Count boolean fields that are true (captured) vs false (not captured)
            let captured = 0;
            let notCaptured = 0;
            
            // Fields to exclude from counting (they're redundant/not displayed in UI)
            const excludeFields = [
                'people_impact_understood',
                'process_impact_understood', 
                'technology_impact_understood'
            ];
            
            for (const [key, value] of Object.entries(criteriaObj)) {
                // Skip non-boolean fields, metadata fields, and excluded fields
                if (typeof value === 'boolean' && !excludeFields.includes(key)) {
                    if (value === true) {
                        captured++;
                    } else {
                        notCaptured++;
                    }
                }
            }
            
            return { captured, notCaptured };
        }

        function buildCriteriaSectionHtml(title, criteriaObj, checklistHtml) {
            const { captured, notCaptured } = countCriteriaStatus(criteriaObj);
            const evidenceItems = criteriaObj.evidence ? criteriaObj.evidence.length : 0;
            const missedOpportunityItems = criteriaObj.missed_opportunities ? criteriaObj.missed_opportunities.length : 0;
            
            return `
                <details>
                    <summary class="criteria-section-header">
                        <span>
                            ${title}
                            ${captured > 0 ? `<span class="evidence-count">${captured} captured</span>` : ''}
                            ${notCaptured > 0 ? `<span class="opportunity-count">${notCaptured} gaps</span>` : ''}
                        </span>
                    </summary>
                    <ul class="criteria-checklist">
                        ${checklistHtml}
                    </ul>
                    ${evidenceItems > 0 ? `
                        <div style="margin-top: 12px;">
                            <strong style="color: #27ae60;">ðŸ“‹ Evidence Captured:</strong>
                            ${buildEvidenceHtml(criteriaObj.evidence)}
                        </div>
                    ` : ''}
                    ${missedOpportunityItems > 0 ? `
                        <div style="margin-top: 12px;">
                            <strong style="color: #e74c3c;">âš ï¸ Missed Opportunities:</strong>
                            ${buildMissedOpportunitiesHtml(criteriaObj.missed_opportunities)}
                        </div>
                    ` : ''}
                </details>
            `;
        }

        function buildClassificationHtml(classification) {
            if (!classification) {
                return '';
            }

            const callTypeLabels = {
                'discovery': 'ðŸ” Discovery Call',
                'poc_scoping': 'ðŸš€ PoC Scoping Call',
                'mixed': 'ðŸ”€ Mixed Call',
                'unclear': 'â“ Unclear'
            };

            const callTypeLabel = callTypeLabels[classification.call_type] || classification.call_type;
            
            const getProgressClass = (score) => {
                if (score >= 70) return 'high';
                if (score >= 40) return 'medium';
                return 'low';
            };

            // Build discovery criteria checklist
            let discoveryCriteriaHtml = '';
            if (classification.discovery_criteria) {
                const dc = classification.discovery_criteria;
                
                const painChecklist = `
                    ${dc.pain_current_state.primary_use_case ? `<li style="margin-bottom: 8px; opacity: 0.9;"><strong>Focus:</strong> ${dc.pain_current_state.primary_use_case}</li>` : ''}
                    <li>${dc.pain_current_state.prompt_model_iteration_understood ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Prompt/model iteration understood (Dev)</li>
                    <li>${dc.pain_current_state.debugging_process_documented ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Debugging process documented (Prod)</li>
                    <li>${dc.pain_current_state.situation_understood ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Situation understood</li>
                    <li>${dc.pain_current_state.resolution_attempts_documented ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Resolution attempts documented</li>
                    <li>${dc.pain_current_state.outcomes_documented ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Outcomes documented</li>
                    <li>${dc.pain_current_state.frequency_quantified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Frequency quantified</li>
                    <li>${dc.pain_current_state.duration_quantified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Duration quantified</li>
                    <li>${dc.pain_current_state.impact_quantified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Impact quantified (People/Process/Tech)</li>
                    <li>${dc.pain_current_state.mttd_mttr_quantified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} MTTD/MTTR quantified</li>
                    <li>${dc.pain_current_state.experiment_time_quantified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Experiment time quantified</li>
                `;
                
                const stakeholderChecklist = `
                    <li>${dc.stakeholder_map.technical_champion_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Technical champion identified</li>
                    <li>${dc.stakeholder_map.technical_champion_engaged ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Technical champion engaged</li>
                    <li>${dc.stakeholder_map.economic_buyer_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Economic buyer identified</li>
                    <li>${dc.stakeholder_map.decision_maker_confirmed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Decision maker confirmed</li>
                `;
                
                const rcChecklist = `
                    <li>${dc.required_capabilities.top_rcs_ranked ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Top RCs ranked</li>
                    <li>${dc.required_capabilities.must_have_vs_nice_to_have_distinguished ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Must-have vs nice-to-have distinguished</li>
                    <li>${dc.required_capabilities.deal_breakers_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Deal-breakers identified</li>
                    <li style="margin-top: 10px; font-weight: 600; opacity: 0.8;">Core Capabilities:</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.llm_agent_tracing_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.llm_agent_tracing_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} LLM/Agent Tracing</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.llm_evaluations_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.llm_evaluations_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} LLM Evaluations</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.production_monitoring_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.production_monitoring_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} Production Monitoring</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.prompt_management_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.prompt_management_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} Prompt Management</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.prompt_experimentation_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.prompt_experimentation_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} Prompt Experimentation</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.monitoring_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.monitoring_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} Monitoring</li>
                    <li style="padding-left: 12px;">${dc.required_capabilities.compliance_important === true ? '<span class="check-icon">âœ“</span>' : dc.required_capabilities.compliance_important === false ? '<span class="x-icon">âœ—</span>' : 'â—‹'} Compliance (SOC2, SSO, GDPR)</li>
                `;
                
                const compChecklist = `
                    <li>${dc.competitive_landscape.current_tools_evaluated ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Current tools evaluated</li>
                    <li>${dc.competitive_landscape.why_looking_vs_staying ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Why looking vs staying</li>
                    <li>${dc.competitive_landscape.key_differentiators_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Key differentiators identified</li>
                    ${dc.competitive_landscape.tools_mentioned && dc.competitive_landscape.tools_mentioned.length > 0 ? 
                        `<li style="margin-top: 8px; opacity: 0.8;">Tools mentioned: ${dc.competitive_landscape.tools_mentioned.join(', ')}</li>` : ''}
                `;
                
                discoveryCriteriaHtml = `
                    <div class="criteria-card">
                        <h4>ðŸ” Discovery Criteria</h4>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(classification.discovery_completion_score)}" 
                                 style="width: ${classification.discovery_completion_score}%"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 15px; font-size: 1.2em;">
                            ${classification.discovery_completion_score.toFixed(0)}% Complete
                        </div>
                        
                        ${buildCriteriaSectionHtml('Pain & Current State', dc.pain_current_state, painChecklist)}
                        ${buildCriteriaSectionHtml('Stakeholder Map', dc.stakeholder_map, stakeholderChecklist)}
                        ${buildCriteriaSectionHtml('Required Capabilities', dc.required_capabilities, rcChecklist)}
                        ${buildCriteriaSectionHtml('Competitive Landscape', dc.competitive_landscape, compChecklist)}
                    </div>
                `;
            }

            // Build PoC scoping criteria checklist
            let pocCriteriaHtml = '';
            if (classification.poc_scoping_criteria) {
                const pc = classification.poc_scoping_criteria;
                
                const useCaseChecklist = `
                    <li>${pc.use_case_scoped.llm_applications_selected ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} LLM application selected (max 1 use case)</li>
                    <li>${pc.use_case_scoped.environment_decided ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Environment decided ${pc.use_case_scoped.environment_type ? `(${pc.use_case_scoped.environment_type})` : ''}</li>
                    <li>${pc.use_case_scoped.trace_volume_estimated ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Trace volume estimated ${pc.use_case_scoped.estimated_volume ? `(${pc.use_case_scoped.estimated_volume})` : ''}</li>
                    <li>${pc.use_case_scoped.llm_provider_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} LLM Provider identified ${pc.use_case_scoped.llm_provider ? `(${pc.use_case_scoped.llm_provider})` : ''}</li>
                    <li>${pc.use_case_scoped.integration_complexity_assessed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Integration complexity assessed</li>
                    ${pc.use_case_scoped.applications_list && pc.use_case_scoped.applications_list.length > 0 ? 
                        `<li style="margin-top: 8px; opacity: 0.8;">Apps: ${pc.use_case_scoped.applications_list.join(', ')}</li>` : ''}
                `;
                
                const implChecklist = `
                    <li>${pc.implementation_requirements.data_residency_confirmed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Data residency confirmed ${pc.implementation_requirements.deployment_model ? `(${pc.implementation_requirements.deployment_model})` : ''}</li>
                    <li>${pc.implementation_requirements.blockers_identified ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Blockers identified</li>
                    ${pc.implementation_requirements.blockers_list && pc.implementation_requirements.blockers_list.length > 0 ? 
                        `<li style="margin-top: 8px; opacity: 0.8;">Blockers: ${pc.implementation_requirements.blockers_list.join(', ')}</li>` : ''}
                `;
                
                const metricsChecklist = `
                    <li>${pc.metrics_success_criteria.specific_metrics_defined ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Specific metrics defined</li>
                    <li>${pc.metrics_success_criteria.baseline_captured ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Baseline captured</li>
                    <li>${pc.metrics_success_criteria.success_measurement_agreed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Success measurement agreed</li>
                    <li>${pc.metrics_success_criteria.competitive_favorable_criteria ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Criteria favorable vs competitors</li>
                    ${pc.metrics_success_criteria.example_metrics && pc.metrics_success_criteria.example_metrics.length > 0 ? 
                        `<li style="margin-top: 8px; opacity: 0.8;">Metrics: ${pc.metrics_success_criteria.example_metrics.join(', ')}</li>` : ''}
                `;
                
                const timelineChecklist = `
                    <li>${pc.timeline_milestones.poc_duration_defined ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} PoC duration defined ${pc.timeline_milestones.duration_weeks ? `(${pc.timeline_milestones.duration_weeks} weeks)` : ''}</li>
                    <li>${pc.timeline_milestones.key_milestones_with_dates ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Key milestones with dates</li>
                    <li>${pc.timeline_milestones.decision_date_committed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Decision date committed ${pc.timeline_milestones.decision_date ? `(${pc.timeline_milestones.decision_date})` : ''}</li>
                    <li>${pc.timeline_milestones.next_steps_discussed ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Next steps discussed</li>
                `;
                
                const resourcesChecklist = `
                    <li>${pc.resources_committed.engineering_resources_allocated ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Engineering resources allocated</li>
                    <li>${pc.resources_committed.checkin_cadence_established ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Check-in cadence established ${pc.resources_committed.cadence ? `(${pc.resources_committed.cadence})` : ''}</li>
                    <li>${pc.resources_committed.communication_channel_created ? '<span class="check-icon">âœ“</span>' : '<span class="x-icon">âœ—</span>'} Communication channel created</li>
                    ${pc.resources_committed.resource_names && pc.resources_committed.resource_names.length > 0 ? 
                        `<li style="margin-top: 8px; opacity: 0.8;">Resources: ${pc.resources_committed.resource_names.join(', ')}</li>` : ''}
                `;
                
                pocCriteriaHtml = `
                    <div class="criteria-card">
                        <h4>ðŸš€ PoC Scoping Criteria</h4>
                        <div class="progress-bar">
                            <div class="progress-fill ${getProgressClass(classification.poc_scoping_completion_score)}" 
                                 style="width: ${classification.poc_scoping_completion_score}%"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 15px; font-size: 1.2em;">
                            ${classification.poc_scoping_completion_score.toFixed(0)}% Complete
                        </div>
                        
                        ${buildCriteriaSectionHtml('Use Case Scoped', pc.use_case_scoped, useCaseChecklist)}
                        ${buildCriteriaSectionHtml('Implementation Requirements', pc.implementation_requirements, implChecklist)}
                        ${buildCriteriaSectionHtml('Metrics & Success Criteria', pc.metrics_success_criteria, metricsChecklist)}
                        ${buildCriteriaSectionHtml('Timeline & Milestones', pc.timeline_milestones, timelineChecklist)}
                        ${buildCriteriaSectionHtml('Resources Committed', pc.resources_committed, resourcesChecklist)}
                    </div>
                `;
            }

            // Build missing elements segmented by call type
            let missingHtml = '';
            const callType = classification.call_type;
            const missingElements = classification.missing_elements || {};
            
            // Show Discovery missing elements for discovery or mixed calls
            const showDiscovery = (callType === 'discovery' || callType === 'mixed' || callType === 'unclear');
            const discoveryMissing = missingElements.discovery || [];
            
            // Show PoC Scoping missing elements for poc_scoping or mixed calls
            const showPocScoping = (callType === 'poc_scoping' || callType === 'mixed' || callType === 'unclear');
            const pocScopingMissing = missingElements.poc_scoping || [];
            
            if ((showDiscovery && discoveryMissing.length > 0) || (showPocScoping && pocScopingMissing.length > 0)) {
                let discoveryHtml = '';
                if (showDiscovery && discoveryMissing.length > 0) {
                    discoveryHtml = `
                        <div class="missing-category">
                            <h5>ðŸ” Discovery Gaps</h5>
                            <ul>
                                ${discoveryMissing.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                let pocScopingHtml = '';
                if (showPocScoping && pocScopingMissing.length > 0) {
                    pocScopingHtml = `
                        <div class="missing-category">
                            <h5>ðŸ“‹ PoC Scoping Gaps</h5>
                            <ul>
                                ${pocScopingMissing.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                missingHtml = `
                    <div class="missing-elements">
                        <h4>âš ï¸ Missing Elements</h4>
                        ${discoveryHtml}
                        ${pocScopingHtml}
                    </div>
                `;
            }

            let recommendationsHtml = '';
            if (classification.recommendations && classification.recommendations.length > 0) {
                recommendationsHtml = `
                    <div class="recommendations-section">
                        <h4>ðŸ’¡ Recommendations for Next Call</h4>
                        <ul>
                            ${classification.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            return `
                <div class="classification-section">
                    <div class="classification-header">
                        <span class="call-type-badge ${classification.call_type}">${callTypeLabel}</span>
                        <span class="confidence-badge">Confidence: ${classification.confidence}</span>
                    </div>
                    
                    <div class="classification-reasoning">
                        ${classification.reasoning}
                    </div>
                    
                    <div class="criteria-grid">
                        ${discoveryCriteriaHtml}
                        ${pocCriteriaHtml}
                    </div>
                    
                    ${missingHtml}
                    ${recommendationsHtml}
                </div>
            `;
        }

        // Allow Enter key in transcript textarea without submitting (if manual tab exists)
        const transcriptEl = document.getElementById('transcript');
        if (transcriptEl) {
            transcriptEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.stopPropagation();
                }
            });
        }
    </script>
</body>
</html>
